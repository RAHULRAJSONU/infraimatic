# Default application configuration for Infraimatic.
server:
  forward-headers-strategy: framework
  error:
    include-binding-errors: always
    include-stacktrace: on_param

spring:
  application:
    name: infraimatic
  main:
    allow-bean-definition-overriding: true
  # The datasource is configured via environment variables or command line
  datasource:
    url: jdbc:postgresql://localhost:5432/infraimatic
    username: postgres
    password: p0$stgres2025
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 30          # tune per CPU/traffic
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      validation-timeout: 5000
      leak-detection-threshold: 0
  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
#        dialect: org.hibernate.dialect.PostgreSQLDialect
        show_sql: false
        format_sql: true
        jdbc.time_zone: UTC
        multiTenancy: DISCRIMINATOR
        use_sql_comments: true
  flyway:
    enabled: false
    locations: classpath:db/migration
#    baseline-on-migrate: true
  # Thymeleaf config
  thymeleaf:
    prefix: classpath:/templates/email/
    suffix: .html
    mode: HTML
    encoding: UTF-8
    cache: false

  ai:
    chat:
      memory:
        repository:
          jdbc:
            initialize-schema: never
      client:
        observations:
          log-prompt: true
          log-completion: true
          include-error-logging: true
    retry:
      max-attempts: 6
      backoff:
        initial-interval: 1s
        multiplier: 2
        max-interval: 30s
    openai:
      api-key: ${GROQ_API_KEY}
      base-url: https://api.groq.com/openai
      chat:
        options:
          model: llama-3.3-70b-versatile
          # model: openai/gpt-oss-20b
          temperature: 0.0

management:
  endpoints:
    web:
      exposure:
        include: health, info, prometheus
  endpoint:
    health:
      show-details: when_authorized
  metrics:
    export:
      prometheus:
        enabled: true

infraimatic:
  security:
    enabled: false
    # In development you can override this secret via environment variable
    jwt:
      secret: dev-secret-key

# OpenApi Swagger configuration
springdoc:
  swagger-ui:
    display-request-duration: true
    operationsSorter: method
    tags-sorter: method
    deep-linking: true
    defaultModelsExpandDepth: 1
    defaultModelExpandDepth: 1
    display-operation-id: false
    filter: false
    show-extensions: false
    use-root-path: true
    show-common-extensions: true
    try-it-out-enabled: true
  cache:
    disabled: false
  show-actuator: false
  writer-with-default-pretty-printer: true

# Identity config
identity:
  ui-host: ${IDENTITY_UI_HOST:http://localhost:3000}
  security:
    encryptionKeyProvider: ${IDENTITY_ENCRYPTION_KEY_PROVIDER:FILE_KEY_PROVIDER}
    privateKeyPath: ${IDENTITY_PRIVATE_KEY_PATH:/run/secrets/identity_private_key.pem}
    publicKeyPath: ${IDENTITY_PUBLIC_KEY_PATH:/run/secrets/identity_public_key.pem}
    keyBeginMarker: ${IDENTITY_KEY_BEGIN_MARKER:-----BEGIN PRIVATE KEY-----}
    keyEndMarker: ${IDENTITY_KEY_END_MARKER:-----END PRIVATE KEY-----}
    password:
      validationRegex: ${IDENTITY_PASSWORD_VALIDATION_REGEX:"^(?=.*[0-9])(?=.*[?!@#$%^&*\\])(?=.*[A-Z])(?=.*[a-z])[a-zA-Z0-9?!@#$%^&*\\].{8,30}$"}
      validationMessage: ${IDENTITY_PASSWORD_VALIDATION_MESSAGE:Invalid password, password should contain at least one lowercase, one uppercase, one digit and one special character. Length should be 8-30 characters.}
      isPasswordReUsageAllowed: ${IDENTITY_PASSWORD_REUSABLE:false} # Can not use old passwords
      oldPasswordSpan: ${IDENTITY_PASSWORD_OLD_SPAN:7} # can not use last 7 passwords
    resetPassword:
      tokenValidityInSecond: ${IDENTITY_RESET_PASSWORD_TOKEN_VALIDITY:600}
      redirectUrl: /identity/reset-password
    secureRandomChar: ${IDENTITY_SECURE_RANDOM_CHAR:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"}
    jwt:
      expiration: ${IDENTITY_JWT_EXPIRATION:86400000}
      refresh-token:
        expiration: ${IDENTITY_JWT_REFRESH_EXPIRATION:604800000}
      secret-key: ${IDENTITY_JWT_SECRET_KEY:eyJhbGciOiJIUzUxMiJ9eyJzdWIiOiJzaHViaGFtLmd1cHRhQGdtYWlsLmNvbSIsImlhdCI6MTY4NzI4NjE3OCwiZXhwIjoxNjg3Mjg5Nzc4fQw4Uc4lHiEPzGXlIWCpyCaLNPoYlarPtNAIrN1OAZqaAxAFLHyDMnETa8BVRQ9cztp4X6lFwlELHsp4j5MyXOcg}
#Logging Conf
logging:
  level:
    org.hibernate.SQL: DEBUG
    org.hibernate.orm.jdbc.bind: TRACE
    org.springframework.boot: error
    org.springframework.security: debug
    org.springframework.security.web: debug
    org.springframework.web: debug
    org.apache.catalina: error
    org.springdoc: debug
    com.mainul35:
      - info
      - trace
      - debug
      - error
      - warn

# Broker settings — used by the DB-backed MessageBroker (JdbcMessageBroker)
broker:
  # Number of partitions to use for topics; producers must use the same value to compute partition.
  # Increase to allow more parallelism at the cost of more DB contention.
  partitions: 8

  # Consumer-related defaults (per consumer runtime)
  consumer:
    # logical consumer group id for this service
    group: whatsapp-processor

    # number of worker threads (partition claim attempts) per consumer instance
    workers: 4

    # batch size to fetch messages per poll
    batch-size: 20

    # maximum number of processing attempts before moving message to DLQ
    max-attempts: 5

    # base backoff milliseconds (exponential backoff applied per attempt)
    base-backoff-millis: 500

    # maximum backoff milliseconds (cap)
    max-backoff-millis: 30000

    # idle delay between polls when no work found
    idle-delay-millis: 200

    # partitions claimed TTL (ms) — advisory lock semantics; used only conceptually here
    claim-lock-ttl-millis: 60000

    # poll interval (ms) - how often workers try to claim new partitions if none available
    poll-interval-ms: 500

storage:
  fs:
    enabled: true
    root-dir: D:/Shared/ezyinfra   # Linux/Mac example
    queue-capacity: 32