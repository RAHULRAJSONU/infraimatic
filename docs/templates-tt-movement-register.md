# Template: `tt_movement_register` – movement register

The **TT Movement Register** template captures the movement of equipment
between sites.  It is intended for use in mining, construction and other
industrial contexts where tracking the movement of tools, pumps or vehicles is
important for logistics and compliance.  Each movement record is identified
by a unique `movementId` and includes information about the equipment, origin
site, destination site, optional operator and reason, and the date of
movement.  Submissions are stored as normalized JSON documents and validated
against the template’s JSON Schema before being persisted【115756199499176†L66-L72】.

## Schema definition

The JSON Schema defining the normalized structure is stored in the database
and enforced by the `SubmissionService`【115756199499176†L68-L71】.  The
following table summarizes the properties exposed by version 1 of the
`tt_movement_register` template (seeded at installation time).  All
properties are simple strings; the `date` field must be a valid ISO 8601
timestamp (e.g. `2025‑09‑28T10:20:00Z`).

| Field        | Type   | Required | Description and notes |
|-------------|-------|---------|----------------------|
| `movementId` | string | ✔ | Unique identifier for this movement.  Clients must provide their own ID or generate one; it is not generated by the system. |
| `equipmentId` | string | ✔ | Identifier of the equipment being moved.  Can be an asset tag, serial number or other code. |
| `fromSite`   | string | ✔ | Name or code of the origin site. |
| `toSite`     | string | ✔ | Name or code of the destination site. |
| `movedBy`    | string | ✘ | Optional name or identifier of the person or team performing the movement. |
| `reason`     | string | ✘ | Optional short description explaining why the equipment was moved. |
| `date`       | string (date‑time) | ✔ | ISO 8601 timestamp when the movement took place.  The system stores the exact string provided, so include a `Z` suffix for UTC. |

The schema disallows additional properties; any unknown fields will trigger
validation errors.

## Managing templates via the API

Infraimatic exposes a REST API under `/api/v1` for creating and retrieving
templates.  Templates are scoped by tenant and template type; version
numbers are assigned automatically.  To create a new template version:

```bash
curl -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d '{
           "name": "TT Movement Register", 
           "jsonSchema": { /* schema JSON here */ }
         }' \
     http://localhost:8080/api/v1/<tenantId>/templates/tt_movement_register
```

To list or fetch templates use `GET /{tenantId}/templates/tt_movement_register` or
`GET /{tenantId}/templates/tt_movement_register/{version}`.  See the
`/swagger‑ui.html` page for interactive documentation【966698866192483†L82-L85】.

## Submission examples

The following examples illustrate how to submit normalized payloads for the
`tt_movement_register` template.  In the examples below replace
`<tenantId>` with your tenant (e.g. `sample_tenant`) and `<token>` with a
valid JWT if security is enabled【966698866192483†L96-L123】.  The version is
assumed to be `1` unless you have created additional versions.

### Example 1 – minimal valid submission

This example demonstrates the minimum required properties.  The optional
`movedBy` and `reason` fields are omitted.  The API will assign an ID to the
submission and echo back the normalized payload.

```bash
curl -X POST \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
        "movementId": "move‑001",
        "equipmentId": "Pump‑3",
        "fromSite": "Site‑A",
        "toSite": "Site‑B",
        "date": "2025‑09‑28T10:20:00Z"
      }' \
  http://localhost:8080/api/v1/<tenantId>/templates/tt_movement_register/1/submissions
```

**Expected response (HTTP 201)**

```json
{
  "id": 42,
  "tenantId": "<tenantId>",
  "type": "tt_movement_register",
  "templateVersion": 1,
  "normalized": {
    "movementId": "move‑001",
    "equipmentId": "Pump‑3",
    "fromSite": "Site‑A",
    "toSite": "Site‑B",
    "date": "2025‑09‑28T10:20:00Z"
  }
}
```

### Example 2 – submission with optional fields

Including `movedBy` and `reason` provides additional context.  These fields
remain optional in the schema.

```bash
curl -X POST \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
        "movementId": "move‑002",
        "equipmentId": "Crane‑17",
        "fromSite": "Yard‑1",
        "toSite": "Site‑C",
        "movedBy": "John Smith",
        "reason": "Scheduled maintenance",
        "date": "2025‑10‑05T09:00:00Z"
      }' \
  http://localhost:8080/api/v1/<tenantId>/templates/tt_movement_register/1/submissions
```

### Example 3 – missing a required field (validation error)

If a required field such as `equipmentId` is omitted the submission will
fail validation.  The API responds with HTTP 400 and a structured error
detailing the violations【115756199499176†L68-L72】.

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
        "movementId": "move‑003",
        "fromSite": "Depot",
        "toSite": "Plant‑4",
        "date": "2025‑10‑10T11:30:00Z"
      }' \
  http://localhost:8080/api/v1/<tenantId>/templates/tt_movement_register/1/submissions
```

**Expected error response (HTTP 400)**

```json
{
  "error": "VALIDATION_ERROR",
  "message": "Normalized payload failed schema validation",
  "details": {
    "errors": [
      {"path": "#.equipmentId", "message": "required property \"equipmentId\" missing"}
    ]
  },
  "timestamp": "2025‑10‑19T12:00:00Z"
}
```

### Example 4 – additional property (validation error)

The schema sets `additionalProperties: false`, so unknown fields are
rejected.  Here the `unexpectedField` will cause a validation error.

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{
        "movementId": "move‑004",
        "equipmentId": "Excavator‑5",
        "fromSite": "Mine‑1",
        "toSite": "Mine‑2",
        "unexpectedField": "xyz",
        "date": "2025‑10‑12T14:15:00Z"
      }' \
  http://localhost:8080/api/v1/<tenantId>/templates/tt_movement_register/1/submissions
```

**Expected error response (HTTP 400)**

```json
{
  "error": "VALIDATION_ERROR",
  "message": "Normalized payload failed schema validation",
  "details": {
    "errors": [
      {"path": "#", "message": "extraneous key [unexpectedField] is not permitted"}
    ]
  },
  "timestamp": "2025‑10‑19T12:00:00Z"
}
```

### Example 5 – NLU parse and submit

Infraimatic includes a basic NLU engine that can parse free‑form sentences
into normalized payloads【115756199499176†L85-L87】.  The following request
demonstrates the end‑to‑end flow: the text is parsed to suggest the
`tt_movement_register` template, the normalized payload is derived via regex
and the submission is persisted【966698866192483†L132-L158】.

```bash
TEXT="Pump‑3 moved from Site‑A to Site‑B for maintenance at 2025‑09‑28T10:20:00Z"
curl -X POST \
  -H "Content-Type: application/json" \
  -d "{\"text\": \"${TEXT}\"}" \
  http://localhost:8080/api/v1/<tenantId>/nlu/submit
```

**Expected response (HTTP 201)**

```json
{
  "submissionId": 84,
  "normalized": {
    "equipmentId": "Pump‑3",
    "fromSite": "Site‑A",
    "toSite": "Site‑B",
    "date": "2025‑09‑28T10:20:00Z"
  }
}
```

> **Note:** the simple NLU implementation does not extract `movementId`,
> `movedBy` or `reason`.  You may need to post‑process the normalized payload
> or adjust your template schema accordingly.  In production you should
> implement a more robust `EnrichmentService` that extracts all required
> attributes and predicts the correct template type【115756199499176†L85-L87】.

## Retrieving submissions

Once persisted you can retrieve a submission by its ID via
`GET /{tenantId}/templates/tt_movement_register/{version}/submissions/{id}`.
The response body returns the normalized payload but intentionally omits
the raw payload and internal metadata for security reasons.【966698866192483†L154-L158】.  To
list all submissions for a template and version use
`GET /{tenantId}/templates/tt_movement_register/{version}/submissions`.
